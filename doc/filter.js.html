<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Filter.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: Filter.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * ZXUI (Zhixin UI)
 * Copyright 2013 Baidu Inc. All rights reserved.
 * 
 * @file 条件过滤器
 * @author chris(wfsr@foxmail.com)
 */

define(function (require) {

    var lib = require('./lib');
    var Control = require('./Control');
    

    /**
     * 条件过滤器
     * 
     * @constructor
     * @extends module:Control
     * @requires Control
     * @exports Filter
     * @example
     * var map = {
     *     '1': [2, 3, 5],
     *     '2': [1, 2, 4]
     * }
     *
     * new Filter({
     *   prefix: 'ecl-ui-filter',
     *   main: me.qq('ecl-ui-filter'),
     *   groups: 'p',
     *   
     *   onChange: function (e) {
     *      
     *     // load data
     *
     *     // disable or enable items
     *     if (e.key === 'type') {
     *         var value = e.value[0];
     *
     *         if (map[value]) {
     *             this.disableItems('special', map[value]);
     *         }
     *         else {
     *             this.enableItems('special');
     *         }
     *     }
     *   }
     *
     * }).render();
     */
    var Filter = Control.extend({


        /**
         * 控件类型标识
         * 
         * @private
         * @type {string}
         */
        type: 'Filter',

        /**
         * 控件配置项
         * 
         * @private
         * @name module:Filter#options
         * @type {Object}
         * @property {boolean} options.disabled 控件的不可用状态
         * @property {(string | HTMLElement)} options.main 控件渲染容器
         * @property {string} options.prefix 控件class前缀，同时将作为main的class之一
         */
        options: {

            // 提示框的不可用状态，默认为false。处于不可用状态的提示框不会出现。
            disabled: false,

            // 控件渲染主容器
            main: '',

            // 控件class前缀，同时将作为main的class之一
            prefix: 'ecl-ui-filter',

            groups: 'p',

            checkedClass: 'checked',

            disabledClass: 'disabled'

        },

        /**
         * 需要绑定 this 的方法名，多个方法以半角逗号分开
         * 
         * @public
         * @type {string}
         */
        binds: 'onClick',

        /**
         * 控件初始化
         * 
         * @private
         * @param {Object} options 控件配置项
         * @see module:Filter#options
         */
        init: function (options) {
            this.disabled  = options.disabled;

            this.main = options.main && lib.g(options.main);
        },


        /**
         * 绘制控件
         * 
         * @public
         * @param {string=|HTMLElement=} wrapper 作为组件根元素的DOM节点
         * @throws 如果控件根元素不存在将抛出异常
         * @return {module:Filter} 当前实例
         */
        render: function (wrapper) {
            var main    = wrapper && lib.g(wrapper) || this.main;
            var options = this.options;

            if (!main) {
                throw new Error('main not found!');
            }

            if (!this.rendered) {
                this.rendered = true;

                var groups = this.groups = {};

                lib.each(
                    main.getElementsByTagName(options.groups),
                    function (group) {

                        // 以第一个 input 标签的 name 作为 key
                        var key = group.getElementsByTagName('input')[0].name;
                        groups[key] = group;
                    }
                );

                lib.on(main, 'click', this.onClick);
            }

            return this;
        },

        /**
         * 处理选单点击事件
         * 
         * @private
         * @param {DOMEvent} e 事件源对象
         * @fires module:Filter#change
         * @fires module:Filter#click
         */
        onClick: function (e) {

            /**
             * @event module:Filter#click
             * @type {object}
             * @property {DOMEvent} event 事件源对象
             */
            this.fire('click', {event: e});

            var target = lib.getTarget(e);
            if (target.type) {

                // HACK: 如果点击的是 单选按钮，先置为非选中状态
                if (target.type === 'radio') {
                    target.checked = false;
                }
                
                target = target.parentNode;
            }

            var options = this.options;
            var checkedClass = options.checkedClass;
            var disabledClass = options.disabledClass;

            var input = target.getElementsByTagName('input')[0];
            var isRadio = input && input.type === 'radio';
            var hasClass = lib.hasClass;
            if (target.tagName === 'LABEL'

                // 忽略禁止状态的选项
                && !hasClass(target, disabledClass)

                // 单选组的第一个选项已选中时的点击忽略
                && !(isRadio && input.checked)
            ) {
                //console.log(target);

                // 防止在 label 外 mouseup 导致 radio/checkbox 未选中
                var isChecked = isRadio
                    ? true
                    : !hasClass(target, checkedClass);

                lib.preventDefault(e);

                var group = this.groups[input.name];
                var checkedItems = lib.q(checkedClass, group);
                if (isRadio) {
                    var lastChecked = lib.q(checkedClass, group)[0];

                    if (lastChecked) {
                        lib.removeClass(lastChecked, checkedClass);
                    }
                }
                else {

                    // 第一个选项（通常叫”不限“或”全部“)的选择具有排他性
                    var firstItem = group.getElementsByTagName('input')[0];
                    if (input === firstItem) {

                        // 当单选按钮处理，选择状态不可切换
                        if (input.checked) {
                            input.checked = true;
                            return;
                        }

                        lib.each(
                            checkedItems,
                            function (item) {
                                lib.removeClass(item, checkedClass);

                                item.getElementsByTagName(
                                    'input'
                                )[0].checked = false;
                            }
                        );                        
                    }
                    else if (firstItem.checked) {
                        firstItem.checked = false;
                        lib.removeClass(firstItem.parentNode, checkedClass);
                    }
                }

                input.checked =  isChecked;

                // HACK: 当点击单/复选框时会导致两次状态变换
                setTimeout(function () {
                    input.checked =  isChecked;
                }, 0);

                T[isChecked ? 'addClass' : 'removeClass'](target, checkedClass);

                var checkedData = isRadio
                    ? {key: input.name, value: [input.value]}
                    : this.getData(input.name);

                // 比较状态变化
                var newValue = checkedData.value.join(',');
                var propertyName = 'data-value';
                if (group.getAttribute(propertyName) !== newValue) {
                    group.setAttribute(propertyName, newValue);

                    /**
                     * @event module:Filter#change
                     * @type {Object}
                     * @property {string} key 过滤项的键名
                     * @property {Array.&lt;string>} value 当前选项组的选中值
                     */
                    this.fire('change', checkedData);
                }
            }
        },

        /**
         * 获取指定键名的当前选中项数据
         * 
         * @public
         * @param {string} key 选择项键名
         * @return {Object} 返回指定键名的选中项数据
         */
        getData: function (key) {
            var group = this.groups[key];
            var value = [];
            var data = {key: key, value: value};

            if (group) {

                var disabledClass = this.options.disabledClass;
                lib.each(
                    group.getElementsByTagName('input'),
                    function (input) {
                        if (input.checked
                            && !lib.hasClass(input.parentNode, disabledClass)
                        ) {
                            value.push(input.value);
                        }
                    }
                );
            }

            return data;
        },

        /**
         * 禁止指定选项组中指定值的项
         * 
         * @public
         * @param {string} key 选项组键名
         * @param {Array.&lt;string>} values 要禁止的指定项的值
         */
        disableItems: function (key, values) {
            var options = this.options;
            var checkedClass = options.checkedClass;
            var disabledClass = options.disabledClass;
            var group = this.groups[key];
            var comma = ',';

            values = comma + values.join(comma) + comma;

            lib.each(
                group.getElementsByTagName('input'),
                function (input) {
                    var parentNode = input.parentNode;
                    if (~values.indexOf(comma + input.value + comma)) {
                        input.checked = false;
                        lib.removeClass(parentNode, checkedClass);
                        lib.addClass(parentNode, disabledClass);
                    }
                    else {
                        lib.removeClass(parentNode, disabledClass);
                    }
                }
            );
        },

        /**
         * 启用指定选项组
         * 
         * @public
         * @param {string} key 选项组关键字
         */
        enableItems: function (key) {
            var disabledClass = this.options.disabledClass;
            var group = this.groups[key];

            lib.each(
                lib.q(disabledClass, group),
                function (label) {
                    lib.removeClass(label, disabledClass);
                }
            );
        }


    });

    return Filter;
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-Calendar.html">Calendar</a></li><li><a href="module-City.html">City</a></li><li><a href="module-Control.html">Control</a></li><li><a href="module-Filter.html">Filter</a></li><li><a href="module-lib.html">lib</a></li><li><a href="module-log.html">log</a></li><li><a href="module-Pager.html">Pager</a></li><li><a href="module-Popup.html">Popup</a></li><li><a href="module-Select.html">Select</a></li><li><a href="module-Tip.html">Tip</a></li></ul><h3>Events</h3><ul><li><a href="module-Calendar.html#event:beforeShow">beforeShow</a></li><li><a href="module-Calendar.html#event:hide">hide</a></li><li><a href="module-Calendar.html#event:pick">pick</a></li><li><a href="module-Calendar.html#event:show">show</a></li><li><a href="module-City.html#event:beforeShow">beforeShow</a></li><li><a href="module-City.html#event:click">click</a></li><li><a href="module-City.html#event:hide">hide</a></li><li><a href="module-City.html#event:pick">pick</a></li><li><a href="module-City.html#event:show">show</a></li><li><a href="module-Control.html#event:disable">disable</a></li><li><a href="module-Control.html#event:dispose">dispose</a></li><li><a href="module-Control.html#event:enable">enable</a></li><li><a href="module-Filter.html#event:change">change</a></li><li><a href="module-Filter.html#event:click">click</a></li><li><a href="module-log.html#event:click">click</a></li><li><a href="module-log.html#event:send">send</a></li><li><a href="module-Pager.html#event:change">change</a></li><li><a href="module-Pager.html#event:click">click</a></li><li><a href="module-Popup.html#event:beforeShow">beforeShow</a></li><li><a href="module-Popup.html#event:click">click</a></li><li><a href="module-Popup.html#event:hide">hide</a></li><li><a href="module-Popup.html#event:show">show</a></li><li><a href="module-Select.html#event:beforeShow">beforeShow</a></li><li><a href="module-Select.html#event:change">change</a></li><li><a href="module-Select.html#event:hide">hide</a></li><li><a href="module-Select.html#event:pick">pick</a></li><li><a href="module-Select.html#event:show">show</a></li><li><a href="module-Tip.html#event:beforeShow">beforeShow</a></li><li><a href="module-Tip.html#event:click">click</a></li><li><a href="module-Tip.html#event:hide">hide</a></li><li><a href="module-Tip.html#event:show">show</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-lib.array.html">array</a></li><li><a href="module-lib.browser.html">browser</a></li><li><a href="module-lib.configurable.html">configurable</a></li><li><a href="module-lib.date.html">date</a></li><li><a href="module-lib.dom.html">dom</a></li><li><a href="module-lib.event.html">event</a></li><li><a href="module-lib.fn.html">fn</a></li><li><a href="module-lib.object.html">object</a></li><li><a href="module-lib.observable.html">observable</a></li><li><a href="module-lib.page.html">page</a></li><li><a href="module-lib.string.html">string</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addChild">addChild</a></li><li><a href="global.html#addTriggers">addTriggers</a></li><li><a href="global.html#appendTo">appendTo</a></li><li><a href="global.html#bindEvents">bindEvents</a></li><li><a href="global.html#binds">binds</a></li><li><a href="global.html#build">build</a></li><li><a href="global.html#buildMonth">buildMonth</a></li><li><a href="global.html#change">change</a></li><li><a href="global.html#checkValidity">checkValidity</a></li><li><a href="global.html#clear">clear</a></li><li><a href="global.html#computePosition">computePosition</a></li><li><a href="global.html#disable">disable</a></li><li><a href="global.html#disabled">disabled</a></li><li><a href="global.html#disableItems">disableItems</a></li><li><a href="global.html#dispose">dispose</a></li><li><a href="global.html#enable">enable</a></li><li><a href="global.html#enableItems">enableItems</a></li><li><a href="global.html#fill">fill</a></li><li><a href="global.html#format">format</a></li><li><a href="global.html#from">from</a></li><li><a href="global.html#getChild">getChild</a></li><li><a href="global.html#getData">getData</a></li><li><a href="global.html#getPage">getPage</a></li><li><a href="global.html#getTotal">getTotal</a></li><li><a href="global.html#getValue">getValue</a></li><li><a href="global.html#getValueAsDate">getValueAsDate</a></li><li><a href="global.html#getYYYYMM">getYYYYMM</a></li><li><a href="global.html#hide">hide</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initChildren">initChildren</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#isDisabled">isDisabled</a></li><li><a href="global.html#isVisible">isVisible</a></li><li><a href="global.html#onBeforeShow">onBeforeShow</a></li><li><a href="global.html#onChange">onChange</a></li><li><a href="global.html#onClick">onClick</a></li><li><a href="global.html#onDisable">onDisable</a></li><li><a href="global.html#onDocClick">onDocClick</a></li><li><a href="global.html#onEnable">onEnable</a></li><li><a href="global.html#onHide">onHide</a></li><li><a href="global.html#onResize">onResize</a></li><li><a href="global.html#onShow">onShow</a></li><li><a href="global.html#pick">pick</a></li><li><a href="global.html#query">query</a></li><li><a href="global.html#refresh">refresh</a></li><li><a href="global.html#removeChild">removeChild</a></li><li><a href="global.html#render">render</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#setContent">setContent</a></li><li><a href="global.html#setPage">setPage</a></li><li><a href="global.html#setRange">setRange</a></li><li><a href="global.html#setTarget">setTarget</a></li><li><a href="global.html#setTitle">setTitle</a></li><li><a href="global.html#setTotal">setTotal</a></li><li><a href="global.html#setValue">setValue</a></li><li><a href="global.html#show">show</a></li><li><a href="global.html#showNextMonth">showNextMonth</a></li><li><a href="global.html#showPreMonth">showPreMonth</a></li><li><a href="global.html#type">type</a></li><li><a href="global.html#updatePrevNextStatus">updatePrevNextStatus</a></li><li><a href="global.html#updateStatus">updateStatus</a></li><li><a href="global.html#validate">validate</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Sun Jul 21 2013 21:45:51 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
